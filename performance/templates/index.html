<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Performance Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4/dist/socket.io.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .connection-status {
            margin-bottom: 20px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .connected {
            background-color: #2ecc71;
        }

        .disconnected {
            background-color: #e74c3c;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .metric-label {
            font-weight: 500;
            color: #7f8c8d;
        }

        .metric-value {
            font-weight: bold;
        }

        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
            margin-top: 15px;
        }

        .progress-bar {
            height: 10px;
            background-color: #ecf0f1;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
        }

        .disk-container {
            margin-top: 15px;
        }

        .disk-item {
            margin-bottom: 10px;
        }

        .disk-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        #agent-select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            margin-left: 10px;
        }
    </style>
</head>

<body>
    <h1>Real-Time System Performance Monitor</h1>

    <div class="connection-status">
        Connection: <span id="connection-status">Disconnected</span>
        <span id="connection-indicator" class="status-indicator disconnected"></span>
        | Agent: <select id="agent-select"></select>
    </div>

    <div class="dashboard">
        <!-- CPU Card -->
        <div class="card">
            <div class="card-header">CPU <span id="cpu-agent-name"></span></div>
            <div class="metric">
                <span class="metric-label">Total Usage:</span>
                <span class="metric-value" id="cpu-percent">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress" id="cpu-progress" style="width: 0%"></div>
            </div>
            <div class="metric">
                <span class="metric-label">Frequency:</span>
                <span class="metric-value" id="cpu-freq">0 MHz</span>
            </div>
            <div class="metric">
                <span class="metric-label">Cores:</span>
                <span class="metric-value" id="cpu-cores">0</span>
            </div>
            <div class="metric">
                <span class="metric-label">Temperature:</span>
                <span class="metric-value" id="cpu-temp">N/A</span>
            </div>
            <div class="chart-container">
                <canvas id="cpuChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="perCpuChart"></canvas>
            </div>
        </div>

        <!-- RAM Card -->
        <div class="card">
            <div class="card-header">Memory (RAM) <span id="ram-agent-name"></span></div>
            <div class="metric">
                <span class="metric-label">Usage:</span>
                <span class="metric-value" id="ram-percent">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress" id="ram-progress" style="width: 0%"></div>
            </div>
            <div class="metric">
                <span class="metric-label">Used:</span>
                <span class="metric-value" id="ram-used">0 GB</span>
            </div>
            <div class="metric">
                <span class="metric-label">Free:</span>
                <span class="metric-value" id="ram-free">0 GB</span>
            </div>
            <div class="metric">
                <span class="metric-label">Total:</span>
                <span class="metric-value" id="ram-total">0 GB</span>
            </div>
            <div class="chart-container">
                <canvas id="ramChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="ramPieChart"></canvas>
            </div>
        </div>

        <!-- Disk Card -->
        <div class="card">
            <div class="card-header">Storage <span id="disk-agent-name"></span></div>
            <div id="disk-info">
                <div class="no-data">No disk data available</div>
            </div>
            <div class="chart-container">
                <canvas id="diskChart"></canvas>
            </div>
        </div>

        <!-- Network Card -->
        <div class="card">
            <div class="card-header">Network <span id="net-agent-name"></span></div>
            <div class="metric">
                <span class="metric-label">Sent:</span>
                <span class="metric-value" id="net-sent">0 MB</span>
            </div>
            <div class="metric">
                <span class="metric-label">Received:</span>
                <span class="metric-value" id="net-recv">0 MB</span>
            </div>
            <div class="metric">
                <span class="metric-label">Speed:</span>
                <span class="metric-value" id="net-speed">0 MB/s ↑↓</span>
            </div>
            <div class="chart-container">
                <canvas id="networkChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Initialize charts and data
        const maxDataPoints = 30;
        let timeData = [];
        let cpuData = [];
        let ramData = [];
        let netSentSpeedData = [];
        let netRecvSpeedData = [];
        let currentAgent = null;
        const agentDataCache = {};

        // Format bytes to human-readable
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // Initialize all charts
        const charts = {
            cpu: new Chart(document.getElementById('cpuChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [], datasets: [{
                        label: 'CPU Usage %',
                        data: [],
                        borderColor: 'rgba(255, 159, 64, 1)',
                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100 },
                        x: { display: true, title: { display: true, text: 'Time' } }
                    }
                }
            }),
            perCpu: new Chart(document.getElementById('perCpuChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: [], datasets: [{
                        label: 'Per-Core Usage %',
                        data: [],
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    }
                }
            }),
            ram: new Chart(document.getElementById('ramChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [], datasets: [{
                        label: 'RAM Usage %',
                        data: [],
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    }
                }
            }),
            ramPie: new Chart(document.getElementById('ramPieChart').getContext('2d'), {
                type: 'pie',
                data: {
                    labels: ['Used', 'Free'], datasets: [{
                        data: [0, 100],
                        backgroundColor: ['rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)'],
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            }),
            disk: new Chart(document.getElementById('diskChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: [], datasets: [
                        {
                            label: 'Used',
                            data: [],
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Free',
                            data: [],
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true }
                    }
                }
            }),
            network: new Chart(document.getElementById('networkChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [], datasets: [
                        {
                            label: 'Upload (MB/s)',
                            data: [],
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: true
                        },
                        {
                            label: 'Download (MB/s)',
                            data: [],
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            })
        };

        // Socket.IO connection with robust configuration
        const socket = io({
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionAttempts: Infinity,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000
        });

        // Connection status indicators
        socket.on('connect', () => {
            console.log('Connected to server with ID:', socket.id);
            document.getElementById('connection-status').textContent = 'Connected';
            document.getElementById('connection-indicator').className = 'status-indicator connected';
            fetchAgents();
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            document.getElementById('connection-status').textContent = 'Disconnected';
            document.getElementById('connection-indicator').className = 'status-indicator disconnected';
        });

        socket.on('connect_error', (error) => {
            console.error('Connection Error:', error);
            document.getElementById('connection-status').textContent = 'Connection Error';
            document.getElementById('connection-indicator').className = 'status-indicator disconnected';
        });

        // Agent selection handler
        document.getElementById('agent-select').addEventListener('change', (e) => {
            currentAgent = e.target.value;
            if (currentAgent && agentDataCache[currentAgent]) {
                updateDashboard(agentDataCache[currentAgent]);
            }
        });

        // Fetch list of active agents
        function fetchAgents() {
            fetch('/api/agents')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('agent-select');
                    select.innerHTML = '';

                    if (data.agents.length === 0) {
                        select.innerHTML = '<option value="">No agents available</option>';
                        return;
                    }

                    select.innerHTML = '<option value="">Select an agent</option>';
                    data.agents.forEach(agent => {
                        const option = document.createElement('option');
                        option.value = agent;
                        option.textContent = agent;
                        select.appendChild(option);

                        // Cache agent data if not already cached
                        if (!agentDataCache[agent]) {
                            fetchAgentData(agent);
                        }
                    });

                    // Select first agent by default
                    if (data.agents.length > 0 && !currentAgent) {
                        select.value = data.agents[0];
                        currentAgent = data.agents[0];
                    }
                })
                .catch(error => {
                    console.error('Error fetching agents:', error);
                });
        }

        // Fetch data for specific agent
        function fetchAgentData(agentName) {
            fetch(`/api/agent_data?agent=${agentName}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.error) {
                        agentDataCache[agentName] = data;
                        if (currentAgent === agentName) {
                            updateDashboard(data);
                        }
                    }
                })
                .catch(error => {
                    console.error(`Error fetching data for ${agentName}:`, error);
                });
        }

        // Handle incoming real-time updates
        socket.on('system_stats', (data) => {
            agentDataCache[data.agent_name] = data.data;

            // Update dropdown if new agent
            if (!document.querySelector(`option[value="${data.agent_name}"]`)) {
                fetchAgents();
            }

            // Update dashboard if current agent
            if (currentAgent === data.agent_name) {
                updateDashboard(data.data);
            }
        });

        // Update dashboard with new data
        function updateDashboard(data) {
            // Update time data with formatted timestamp
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            timeData.push(timeStr);
            if (timeData.length > maxDataPoints) timeData.shift();

            // Update agent names
            document.querySelectorAll('#cpu-agent-name, #ram-agent-name, #disk-agent-name, #net-agent-name')
                .forEach(el => el.textContent = data.agent_name || '');

            // CPU Updates
            document.getElementById('cpu-percent').textContent = `${data.cpu.percent.toFixed(1)}%`;
            document.getElementById('cpu-progress').style.width = `${data.cpu.percent}%`;
            document.getElementById('cpu-freq').textContent = `${Math.round(data.cpu.freq)} MHz`;
            document.getElementById('cpu-cores').textContent =
                `${data.cpu.cores} physical, ${data.cpu.logical_cores} logical`;
            document.getElementById('cpu-temp').textContent =
                data.cpu.temperature ? `${data.cpu.temperature}°C` : 'N/A';

            // Update CPU chart
            cpuData.push(data.cpu.percent);
            if (cpuData.length > maxDataPoints) cpuData.shift();
            charts.cpu.data.labels = timeData;
            charts.cpu.data.datasets[0].data = cpuData;
            charts.cpu.update();

            // Update per-CPU chart
            charts.perCpu.data.labels = data.cpu.per_cpu.map((_, i) => `Core ${i + 1}`);
            charts.perCpu.data.datasets[0].data = data.cpu.per_cpu;
            charts.perCpu.update();

            // RAM Updates
            document.getElementById('ram-percent').textContent = `${data.ram.percent.toFixed(1)}%`;
            document.getElementById('ram-progress').style.width = `${data.ram.percent}%`;
            document.getElementById('ram-used').textContent = formatBytes(data.ram.used, 2);
            document.getElementById('ram-free').textContent = formatBytes(data.ram.free, 2);
            document.getElementById('ram-total').textContent = formatBytes(data.ram.total, 2);

            // Update RAM chart
            ramData.push(data.ram.percent);
            if (ramData.length > maxDataPoints) ramData.shift();
            charts.ram.data.labels = timeData;
            charts.ram.data.datasets[0].data = ramData;
            charts.ram.update();

            // Update RAM pie chart
            charts.ramPie.data.datasets[0].data = [
                (data.ram.used / data.ram.total * 100).toFixed(1),
                (data.ram.free / data.ram.total * 100).toFixed(1)
            ];
            charts.ramPie.update();

            // Disk Updates
            const diskInfoContainer = document.getElementById('disk-info');
            diskInfoContainer.innerHTML = '';

            if (data.disks && data.disks.length > 0) {
                const validDisks = data.disks.filter(d => d.total > 0);

                if (validDisks.length > 0) {
                    validDisks.forEach(disk => {
                        const diskItem = document.createElement('div');
                        diskItem.className = 'disk-item';
                        diskItem.innerHTML = `
                        <div class="disk-name">${disk.mountpoint}</div>
                        <div class="metric">
                            <span class="metric-label">Usage:</span>
                            <span class="metric-value">${disk.percent.toFixed(1)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress" style="width: ${disk.percent}%"></div>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Used:</span>
                            <span class="metric-value">${formatBytes(disk.used)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Free:</span>
                            <span class="metric-value">${formatBytes(disk.free)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Total:</span>
                            <span class="metric-value">${formatBytes(disk.total)}</span>
                        </div>
                    `;
                        diskInfoContainer.appendChild(diskItem);
                    });

                    // Update disk chart
                    charts.disk.data.labels = validDisks.map(d => d.mountpoint);
                    charts.disk.data.datasets[0].data = validDisks.map(d => d.used / (1024 ** 3)); // GB
                    charts.disk.data.datasets[1].data = validDisks.map(d => d.free / (1024 ** 3)); // GB
                    charts.disk.update();
                } else {
                    diskInfoContainer.innerHTML = '<div class="no-data">No disk data available</div>';
                }
            } else {
                diskInfoContainer.innerHTML = '<div class="no-data">No disk data available</div>';
            }

            // Network Updates
            // const sentSpeed = data.network.sent_speed || 0;
            // const recvSpeed = data.network.recv_speed || 0;

            // document.getElementById('net-sent').textContent =
            //     `${(data.network.bytes_sent / (1024 ** 2)).toFixed(2)} MB`;
            // document.getElementById('net-recv').textContent =
            //     `${(data.network.bytes_recv / (1024 ** 2)).toFixed(2)} MB`;
            // document.getElementById('net-speed').textContent =
            //     `↑${sentSpeed.toFixed(2)} ↓${recvSpeed.toFixed(2)} MB/s`;
            
            // Network Updates
            const sentSpeed = data.network.sent_speed_mbps || 0;
            const recvSpeed = data.network.recv_speed_mbps || 0;

            document.getElementById('net-agent-name').textContent = `(${data.agent_name})`;

            document.getElementById('net-sent').textContent =
                `${(data.network.bytes_sent / (1024 ** 2)).toFixed(2)} MB`;

            document.getElementById('net-recv').textContent =
                `${(data.network.bytes_recv / (1024 ** 2)).toFixed(2)} MB`;

            document.getElementById('net-speed').textContent =
                `↑ ${sentSpeed.toFixed(2)} Mbps ↓ ${recvSpeed.toFixed(2)} Mbps`;

            // Update network chart
            netSentSpeedData.push(sentSpeed);
            netRecvSpeedData.push(recvSpeed);
            if (netSentSpeedData.length > maxDataPoints) netSentSpeedData.shift();
            if (netRecvSpeedData.length > maxDataPoints) netRecvSpeedData.shift();

            charts.network.data.labels = timeData.slice(-maxDataPoints);
            charts.network.data.datasets[0].data = netSentSpeedData;
            charts.network.data.datasets[1].data = netRecvSpeedData;
            charts.network.update();
        }

        // Debugging helper
        window.debugSocket = socket;
        console.log('Socket.IO instance available as window.debugSocket');
    </script>
</body>

</html>