<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>System Performance Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4/dist/socket.io.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-primary: #f9fafb;
        --bg-secondary: #ffffff;
        --bg-tertiary: #f3f4f6;
        --text-primary: #111827;
        --text-secondary: #4b5563;
        --text-tertiary: #6b7280;
        --accent: #3b82f6;
        --accent-hover: #2563eb;
        --success: #10b981;
        --success-hover: #059669;
        --warning: #f59e0b;
        --warning-hover: #d97706;
        --danger: #ef4444;
        --danger-hover: #dc2626;
        --border: #e5e7eb;
        --border-dark: #d1d5db;
        --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        --card-shadow-hover: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        --chart-bg: rgba(59, 130, 246, 0.03);
        --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        --radius: 12px;
        --radius-sm: 8px;
      }

      .dark-theme {
        --bg-primary: #111827;
        --bg-secondary: #1f2937;
        --bg-tertiary: #374151;
        --text-primary: #f9fafb;
        --text-secondary: #d1d5db;
        --text-tertiary: #9ca3af;
        --accent: #60a5fa;
        --accent-hover: #3b82f6;
        --border: #374151;
        --border-dark: #4b5563;
        --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        --card-shadow-hover: 0 10px 25px -5px rgba(0, 0, 0, 0.25);
        --chart-bg: rgba(96, 165, 250, 0.08);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        padding: 24px;
        transition: var(--transition);
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
      }

      h1 {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 24px;
        color: var(--text-primary);
        letter-spacing: -0.025em;
        background: linear-gradient(90deg, var(--accent), var(--accent-hover));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        display: inline-block;
        animation: fadeInUp 0.5s ease-out;
      }

      .dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
        gap: 24px;
        margin-top: 24px;
      }

      .card {
        background: var(--bg-secondary);
        border-radius: var(--radius);
        box-shadow: var(--card-shadow);
        padding: 24px;
        border: 1px solid var(--border);
        transition: var(--transition);
        animation: fadeIn 0.4s ease-out forwards;
        opacity: 0;
        transform: translateY(10px);
      }

      .card:nth-child(1) {
        animation-delay: 0.1s;
      }
      .card:nth-child(2) {
        animation-delay: 0.2s;
      }
      .card:nth-child(3) {
        animation-delay: 0.3s;
      }
      .card:nth-child(4) {
        animation-delay: 0.4s;
      }

      @keyframes fadeIn {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: var(--card-shadow-hover);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
      }

      .card-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .card-title svg {
        width: 20px;
        height: 20px;
        fill: var(--accent);
      }

      .agent-name {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .connection-status {
        margin-bottom: 24px;
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: var(--radius);
        box-shadow: var(--card-shadow);
        display: flex;
        align-items: center;
        gap: 12px;
        border: 1px solid var(--border);
        transition: var(--transition);
        animation: fadeInUp 0.4s ease-out;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        transition: var(--transition);
        position: relative;
      }

      .connected {
        background-color: var(--success);
        box-shadow: 0 0 0 2px var(--bg-secondary), 0 0 0 4px var(--success);
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
        }
      }

      .disconnected {
        background-color: var(--danger);
      }

      .connecting {
        background-color: var(--warning);
        animation: pulse-warning 2s infinite;
      }

      @keyframes pulse-warning {
        0% {
          box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(245, 158, 11, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(245, 158, 11, 0);
        }
      }

      .metric-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-bottom: 20px;
      }

      .metric {
        background: var(--bg-tertiary);
        border-radius: var(--radius-sm);
        padding: 16px;
        transition: var(--transition);
      }

      .metric:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      .metric-label {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-secondary);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .metric-label svg {
        width: 16px;
        height: 16px;
        fill: var(--text-tertiary);
      }

      .metric-value {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1.3;
      }

      .metric-unit {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-tertiary);
        margin-left: 4px;
      }

      .progress-container {
        margin: 20px 0;
      }

      .progress-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .progress-title {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-secondary);
      }

      .progress-value {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .progress-bar {
        height: 8px;
        background-color: var(--border);
        border-radius: 4px;
        overflow: hidden;
        transition: var(--transition);
      }

      .progress {
        height: 100%;
        background: linear-gradient(90deg, var(--accent), var(--accent-hover));
        transition: width 0.6s cubic-bezier(0.16, 1, 0.3, 1),
          background 0.3s ease;
        border-radius: 4px;
      }

      .progress.warning {
        background: linear-gradient(
          90deg,
          var(--warning),
          var(--warning-hover)
        );
      }

      .progress.danger {
        background: linear-gradient(90deg, var(--danger), var(--danger-hover));
      }

      .chart-container {
        position: relative;
        height: 220px;
        width: 100%;
        margin-top: 20px;
        background: var(--chart-bg);
        border-radius: var(--radius-sm);
        padding: 12px;
        transition: var(--transition);
        border: 1px solid var(--border);
      }

      .disk-container {
        margin-top: 16px;
      }

      .disk-item {
        margin-bottom: 16px;
        padding: 16px;
        background: var(--bg-tertiary);
        border-radius: var(--radius-sm);
        border-left: 3px solid var(--accent);
        transition: var(--transition);
        animation: slideIn 0.4s ease-out forwards;
        opacity: 0;
        transform: translateX(-10px);
      }

      .disk-item:nth-child(1) {
        animation-delay: 0.1s;
      }
      .disk-item:nth-child(2) {
        animation-delay: 0.2s;
      }
      .disk-item:nth-child(3) {
        animation-delay: 0.3s;
      }

      @keyframes slideIn {
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .disk-item:hover {
        transform: translateX(4px);
      }

      .disk-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .disk-name {
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .disk-name svg {
        width: 18px;
        height: 18px;
        fill: var(--accent);
      }

      .disk-percent {
        font-weight: 700;
        color: var(--text-primary);
      }

      .disk-details {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-top: 12px;
      }

      .disk-detail {
        font-size: 13px;
      }

      .disk-detail-label {
        color: var(--text-secondary);
        margin-bottom: 4px;
      }

      .disk-detail-value {
        font-weight: 600;
        color: var(--text-primary);
      }

      #agent-select {
        padding: 10px 14px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-dark);
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-family: inherit;
        font-size: 14px;
        margin-left: auto;
        cursor: pointer;
        transition: var(--transition);
        min-width: 200px;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px;
      }

      #agent-select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      }

      .theme-toggle {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 100;
        transition: var(--transition);
      }

      .theme-toggle:hover {
        transform: scale(1.1) rotate(15deg);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
      }

      .theme-toggle svg {
        width: 22px;
        height: 22px;
        fill: var(--text-secondary);
        transition: var(--transition);
      }

      .dark-theme .theme-toggle svg {
        fill: #fbbf24;
      }

      .no-data {
        color: var(--text-tertiary);
        font-size: 14px;
        text-align: center;
        padding: 20px;
        font-style: italic;
      }

      .glow {
        animation: glow 2s ease-in-out infinite alternate;
      }

      @keyframes glow {
        from {
          box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
        }
        to {
          box-shadow: 0 0 15px rgba(59, 130, 246, 0.8);
        }
      }

      @media (max-width: 768px) {
        body {
          padding: 16px;
        }

        .dashboard {
          grid-template-columns: 1fr;
        }

        .connection-status {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
        }

        #agent-select {
          margin-left: 0;
          width: 100%;
        }

        h1 {
          font-size: 24px;
        }

        .metric-grid {
          grid-template-columns: 1fr;
        }

        .disk-details {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>

  <body>
    <h1>System Performance Dashboard</h1>

    <div class="connection-status">
      <div style="display: flex; align-items: center; gap: 8px">
        <span>Status:</span>
        <span id="connection-status">Disconnected</span>
        <span
          id="connection-indicator"
          class="status-indicator disconnected"
        ></span>
      </div>
      <select id="agent-select">
        <option value="">Loading agents...</option>
      </select>
    </div>

    <div class="dashboard">
      <!-- CPU Card -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <svg viewBox="0 0 24 24">
              <path
                d="M4 19h16v1H4zm0-3h16v1H4zm0-3h16v1H4zm0-3h16v1H4zm0-3h16v1H4zm0-3h16v1H4zM4 4h16v1H4z"
              />
            </svg>
            CPU <span id="cpu-agent-name" class="agent-name"></span>
          </div>
        </div>

        <div class="metric-grid">
          <div class="metric">
            <div class="metric-label">
              <svg viewBox="0 0 24 24">
                <path
                  d="M12 2v4m0 12v4M5 12H1m22 0h-4m1-7l-3 3m-12-3l3 3m-3 7l3-3m12 3l-3-3"
                />
              </svg>
              Usage
            </div>
            <div class="metric-value" id="cpu-percent">
              0<span class="metric-unit">%</span>
            </div>
          </div>

          <div class="metric">
            <div class="metric-label">
              <svg viewBox="0 0 24 24">
                <path
                  d="M13 2v3m0 12v3M4 13H1m22 0h-3m2-8l-3 3m-12-3l3 3m-3 12l3-3m12 3l-3-3"
                />
              </svg>
              Frequency
            </div>
            <div class="metric-value" id="cpu-freq">
              0<span class="metric-unit">MHz</span>
            </div>
          </div>

          <div class="metric">
            <div class="metric-label">
              <svg viewBox="0 0 24 24">
                <path
                  d="M12 12h4v4h-4zm0-8h4v4h-4zm0 16h4v4h-4zM4 4h4v4H4zm0 8h4v4H4zm0 8h4v4H4z"
                />
              </svg>
              Cores
            </div>
            <div class="metric-value" id="cpu-cores">0</div>
          </div>

          <div class="metric">
            <div class="metric-label">
              <svg viewBox="0 0 24 24">
                <path
                  d="M12 16a4 4 0 100-8 4 4 0 000 8zm0 4a8 8 0 100-16 8 8 0 000 16zm0-12v4m0 4v4"
                />
              </svg>
              Temperature
            </div>
            <div class="metric-value" id="cpu-temp">N/A</div>
          </div>
        </div>

        <div class="progress-container">
          <div class="progress-header">
            <div class="progress-title">CPU Load</div>
            <div class="progress-value" id="cpu-load">0%</div>
          </div>
          <div class="progress-bar">
            <div class="progress" id="cpu-progress" style="width: 0%"></div>
          </div>
        </div>

        <div class="chart-container">
          <canvas id="cpuChart"></canvas>
        </div>
      </div>

      <!-- RAM Card -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <svg viewBox="0 0 24 24">
              <path d="M4 4h16v16H4V4zm2 2v12h12V6H6zm2 2h8v8H8V8z" />
            </svg>
            Memory <span id="ram-agent-name" class="agent-name"></span>
          </div>
        </div>

        <div class="metric-grid">
          <div class="metric">
            <div class="metric-label">
              <svg viewBox="0 0 24 24">
                <path
                  d="M12 2v4m0 12v4M5 12H1m22 0h-4m1-7l-3 3m-12-3l3 3m-3 7l3-3m12 3l-3-3"
                />
              </svg>
              Usage
            </div>
            <div class="metric-value" id="ram-percent">
              0<span class="metric-unit">%</span>
            </div>
          </div>

          <div class="metric">
            <div class="metric-label">
              <svg viewBox="0 0 24 24">
                <path d="M4 4h16v16H4V4zm2 2v12h12V6H6z" />
              </svg>
              Used
            </div>
            <div class="metric-value" id="ram-used">
              0<span class="metric-unit">GB</span>
            </div>
          </div>

          <div class="metric">
            <div class="metric-label">
              <svg viewBox="0 0 24 24">
                <path d="M4 4h16v16H4V4zm2 2v12h12V6H6z" />
                <path d="M8 8h8v8H8z" fill="currentColor" />
              </svg>
              Free
            </div>
            <div class="metric-value" id="ram-free">
              0<span class="metric-unit">GB</span>
            </div>
          </div>

          <div class="metric">
            <div class="metric-label">
              <svg viewBox="0 0 24 24">
                <path d="M4 4h16v16H4V4zm2 2v12h12V6H6z" />
              </svg>
              Total
            </div>
            <div class="metric-value" id="ram-total">
              0<span class="metric-unit">GB</span>
            </div>
          </div>
        </div>

        <div class="progress-container">
          <div class="progress-header">
            <div class="progress-title">Memory Usage</div>
            <div class="progress-value" id="ram-usage">0%</div>
          </div>
          <div class="progress-bar">
            <div class="progress" id="ram-progress" style="width: 0%"></div>
          </div>
        </div>

        <div class="chart-container">
          <canvas id="ramChart"></canvas>
        </div>
      </div>

      <!-- Disk Card -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <svg viewBox="0 0 24 24">
              <path d="M4 4h16v16H4V4zm2 2v12h12V6H6zm2 2h8v8H8V8z" />
            </svg>
            Storage <span id="disk-agent-name" class="agent-name"></span>
          </div>
        </div>

        <div id="disk-info">
          <div class="no-data">No disk data available</div>
        </div>

        <div class="chart-container">
          <canvas id="diskChart"></canvas>
        </div>
      </div>

      <!-- Network Card -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <svg viewBox="0 0 24 24">
              <path
                d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 18a8 8 0 110-16 8 8 0 010 16z"
              />
              <path
                d="M12 8a4 4 0 100 8 4 4 0 000-8zm0 6a2 2 0 110-4 2 2 0 010 4z"
              />
            </svg>
            Network <span id="net-agent-name" class="agent-name"></span>
          </div>
        </div>

        <div class="metric-grid">
          <div class="metric">
            <div class="metric-label">
              <svg viewBox="0 0 24 24">
                <path
                  d="M12 2v4m0 12v4M5 12H1m22 0h-4m1-7l-3 3m-12-3l3 3m-3 7l3-3m12 3l-3-3"
                />
              </svg>
              Upload
            </div>
            <div class="metric-value" id="net-sent">
              0<span class="metric-unit">MB</span>
            </div>
          </div>

          <div class="metric">
            <div class="metric-label">
              <svg viewBox="0 0 24 24">
                <path
                  d="M12 2v4m0 12v4M5 12H1m22 0h-4m1-7l-3 3m-12-3l3 3m-3 7l3-3m12 3l-3-3"
                />
              </svg>
              Download
            </div>
            <div class="metric-value" id="net-recv">
              0<span class="metric-unit">MB</span>
            </div>
          </div>

          <div class="metric">
            <div class="metric-label">
              <svg viewBox="0 0 24 24">
                <path
                  d="M12 2v4m0 12v4M5 12H1m22 0h-4m1-7l-3 3m-12-3l3 3m-3 7l3-3m12 3l-3-3"
                />
              </svg>
              Speed
            </div>
            <div class="metric-value" id="net-speed">
              0<span class="metric-unit">Mbps</span>
            </div>
          </div>
        </div>

        <div class="chart-container">
          <canvas id="networkChart"></canvas>
        </div>
      </div>
    </div>

    <div class="theme-toggle" id="themeToggle" data-tooltip="Toggle dark mode">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path
          d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1-8.313-12.454z"
        />
      </svg>
    </div>

    <script>
      // Initialize charts and data
      const maxDataPoints = 30;
      let timeData = [];
      let cpuData = [];
      let ramData = [];
      let netSentSpeedData = [];
      let netRecvSpeedData = [];
      let currentAgent = null;
      const agentDataCache = {};

      // Format bytes to human-readable
      function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ["Bytes", "KB", "MB", "GB", "TB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return (
          parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + " " + sizes[i]
        );
      }

      // Update progress bar color based on value
      function updateProgressBar(element, value) {
        const progressBar = element;
        progressBar.style.width = `${value}%`;

        // Remove all color classes
        progressBar.classList.remove("warning", "danger");

        // Add appropriate class based on value
        if (value > 80) {
          progressBar.classList.add("danger");
        } else if (value > 60) {
          progressBar.classList.add("warning");
        }
      }

      // Initialize all charts with theme-aware colors
      function initCharts() {
        return {
          cpu: new Chart(document.getElementById("cpuChart").getContext("2d"), {
            type: "line",
            data: {
              labels: [],
              datasets: [
                {
                  label: "CPU Usage %",
                  data: [],
                  borderColor: "var(--accent)",
                  backgroundColor: "rgba(59, 130, 246, 0.1)",
                  borderWidth: 2,
                  tension: 0.1,
                  fill: true,
                  pointRadius: 0,
                  pointHoverRadius: 6,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              animation: {
                duration: 1000,
                easing: "easeOutQuart",
              },
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100,
                  grid: {
                    color: "rgba(0, 0, 0, 0.05)",
                  },
                  ticks: {
                    color: "var(--text-secondary)",
                  },
                },
                x: {
                  grid: {
                    display: false,
                  },
                  ticks: {
                    color: "var(--text-secondary)",
                  },
                },
              },
              plugins: {
                legend: {
                  display: false,
                },
                tooltip: {
                  backgroundColor: "var(--bg-secondary)",
                  titleColor: "var(--text-primary)",
                  bodyColor: "var(--text-primary)",
                  borderColor: "var(--border)",
                  borderWidth: 1,
                  padding: 12,
                  cornerRadius: 8,
                  displayColors: false,
                  callbacks: {
                    label: function (context) {
                      return `${
                        context.dataset.label
                      }: ${context.parsed.y.toFixed(1)}%`;
                    },
                  },
                },
              },
              interaction: {
                intersect: false,
                mode: "index",
              },
            },
          }),
          ram: new Chart(document.getElementById("ramChart").getContext("2d"), {
            type: "line",
            data: {
              labels: [],
              datasets: [
                {
                  label: "RAM Usage %",
                  data: [],
                  borderColor: "var(--success)",
                  backgroundColor: "rgba(16, 185, 129, 0.1)",
                  borderWidth: 2,
                  tension: 0.1,
                  fill: true,
                  pointRadius: 0,
                  pointHoverRadius: 6,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              animation: {
                duration: 1000,
                easing: "easeOutQuart",
              },
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100,
                  grid: {
                    color: "rgba(0, 0, 0, 0.05)",
                  },
                  ticks: {
                    color: "var(--text-secondary)",
                  },
                },
                x: {
                  grid: {
                    display: false,
                  },
                  ticks: {
                    color: "var(--text-secondary)",
                  },
                },
              },
              plugins: {
                legend: {
                  display: false,
                },
                tooltip: {
                  backgroundColor: "var(--bg-secondary)",
                  titleColor: "var(--text-primary)",
                  bodyColor: "var(--text-primary)",
                  borderColor: "var(--border)",
                  borderWidth: 1,
                  padding: 12,
                  cornerRadius: 8,
                  displayColors: false,
                  callbacks: {
                    label: function (context) {
                      return `${
                        context.dataset.label
                      }: ${context.parsed.y.toFixed(1)}%`;
                    },
                  },
                },
              },
              interaction: {
                intersect: false,
                mode: "index",
              },
            },
          }),
          disk: new Chart(
            document.getElementById("diskChart").getContext("2d"),
            {
              type: "bar",
              data: {
                labels: [],
                datasets: [
                  {
                    label: "Used",
                    data: [],
                    backgroundColor: "var(--accent)",
                    borderColor: "var(--accent-dark)",
                    borderWidth: 1,
                    borderRadius: 4,
                  },
                  {
                    label: "Free",
                    data: [],
                    backgroundColor: "var(--border)",
                    borderColor: "var(--border-dark)",
                    borderWidth: 1,
                    borderRadius: 4,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                  duration: 1000,
                  easing: "easeOutQuart",
                },
                scales: {
                  x: {
                    stacked: true,
                    grid: {
                      display: false,
                    },
                    ticks: {
                      color: "var(--text-secondary)",
                    },
                  },
                  y: {
                    stacked: true,
                    beginAtZero: true,
                    grid: {
                      color: "rgba(0, 0, 0, 0.05)",
                    },
                    ticks: {
                      color: "var(--text-secondary)",
                    },
                  },
                },
                plugins: {
                  legend: {
                    position: "bottom",
                    labels: {
                      color: "var(--text-primary)",
                      font: {
                        family: "Inter",
                      },
                      padding: 20,
                      usePointStyle: true,
                      pointStyle: "rectRounded",
                    },
                  },
                  tooltip: {
                    backgroundColor: "var(--bg-secondary)",
                    titleColor: "var(--text-primary)",
                    bodyColor: "var(--text-primary)",
                    borderColor: "var(--border)",
                    borderWidth: 1,
                    padding: 12,
                    cornerRadius: 8,
                    callbacks: {
                      label: function (context) {
                        return `${
                          context.dataset.label
                        }: ${context.parsed.y.toFixed(2)} GB`;
                      },
                    },
                  },
                },
                interaction: {
                  intersect: false,
                  mode: "index",
                },
              },
            }
          ),
          network: new Chart(
            document.getElementById("networkChart").getContext("2d"),
            {
              type: "line",
              data: {
                labels: [],
                datasets: [
                  {
                    label: "Upload (Mbps)",
                    data: [],
                    borderColor: "var(--danger)",
                    backgroundColor: "rgba(239, 68, 68, 0.1)",
                    borderWidth: 2,
                    tension: 0.1,
                    fill: true,
                    pointRadius: 0,
                    pointHoverRadius: 6,
                  },
                  {
                    label: "Download (Mbps)",
                    data: [],
                    borderColor: "var(--accent)",
                    backgroundColor: "rgba(59, 130, 246, 0.1)",
                    borderWidth: 2,
                    tension: 0.1,
                    fill: true,
                    pointRadius: 0,
                    pointHoverRadius: 6,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                  duration: 1000,
                  easing: "easeOutQuart",
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    grid: {
                      color: "rgba(0, 0, 0, 0.05)",
                    },
                    ticks: {
                      color: "var(--text-secondary)",
                    },
                  },
                  x: {
                    grid: {
                      display: false,
                    },
                    ticks: {
                      color: "var(--text-secondary)",
                    },
                  },
                },
                plugins: {
                  legend: {
                    position: "bottom",
                    labels: {
                      color: "var(--text-primary)",
                      font: {
                        family: "Inter",
                      },
                      padding: 20,
                      usePointStyle: true,
                      pointStyle: "circle",
                    },
                  },
                  tooltip: {
                    backgroundColor: "var(--bg-secondary)",
                    titleColor: "var(--text-primary)",
                    bodyColor: "var(--text-primary)",
                    borderColor: "var(--border)",
                    borderWidth: 1,
                    padding: 12,
                    cornerRadius: 8,
                    callbacks: {
                      label: function (context) {
                        return `${
                          context.dataset.label
                        }: ${context.parsed.y.toFixed(2)} Mbps`;
                      },
                    },
                  },
                },
                interaction: {
                  intersect: false,
                  mode: "index",
                },
              },
            }
          ),
        };
      }

      let charts = initCharts();

      // Socket.IO connection with robust configuration
      const socket = io({
        transports: ["websocket", "polling"],
        reconnection: true,
        reconnectionAttempts: Infinity,
        reconnectionDelay: 1000,
        reconnectionDelayMax: 5000,
      });

      // Connection status indicators
      socket.on("connect", () => {
        console.log("Connected to server with ID:", socket.id);
        document.getElementById("connection-status").textContent = "Connected";
        document.getElementById("connection-indicator").className =
          "status-indicator connected";
        fetchAgents();
      });

      socket.on("disconnect", () => {
        console.log("Disconnected from server");
        document.getElementById("connection-status").textContent =
          "Disconnected";
        document.getElementById("connection-indicator").className =
          "status-indicator disconnected";
      });

      socket.on("connect_error", (error) => {
        console.error("Connection Error:", error);
        document.getElementById("connection-status").textContent =
          "Connection Error";
        document.getElementById("connection-indicator").className =
          "status-indicator disconnected";
      });

      socket.on("reconnecting", (attempt) => {
        console.log(`Attempting to reconnect (attempt ${attempt})`);
        document.getElementById("connection-status").textContent =
          "Reconnecting...";
        document.getElementById("connection-indicator").className =
          "status-indicator connecting";
      });

      // Agent selection handler
      document
        .getElementById("agent-select")
        .addEventListener("change", (e) => {
          currentAgent = e.target.value;
          if (currentAgent && agentDataCache[currentAgent]) {
            updateDashboard(agentDataCache[currentAgent]);
          }
        });

      // Fetch list of active agents
      function fetchAgents() {
        fetch("/api/agents")
          .then((response) => response.json())
          .then((data) => {
            const select = document.getElementById("agent-select");
            select.innerHTML = "";

            if (data.agents.length === 0) {
              select.innerHTML =
                '<option value="">No agents available</option>';
              return;
            }

            select.innerHTML = '<option value="">Select an agent</option>';
            data.agents.forEach((agent) => {
              const option = document.createElement("option");
              option.value = agent;
              option.textContent = agent;
              select.appendChild(option);

              // Cache agent data if not already cached
              if (!agentDataCache[agent]) {
                fetchAgentData(agent);
              }
            });

            // Select first agent by default
            if (data.agents.length > 0 && !currentAgent) {
              select.value = data.agents[0];
              currentAgent = data.agents[0];
            }
          })
          .catch((error) => {
            console.error("Error fetching agents:", error);
          });
      }

      // Fetch data for specific agent
      function fetchAgentData(agentName) {
        fetch(`/api/agent_data?agent=${agentName}`)
          .then((response) => response.json())
          .then((data) => {
            if (!data.error) {
              agentDataCache[agentName] = data;
              if (currentAgent === agentName) {
                updateDashboard(data);
              }
            }
          })
          .catch((error) => {
            console.error(`Error fetching data for ${agentName}:`, error);
          });
      }

      // Handle incoming real-time updates
      socket.on("system_stats", (data) => {
        agentDataCache[data.agent_name] = data.data;

        // Update dropdown if new agent
        if (!document.querySelector(`option[value="${data.agent_name}"]`)) {
          fetchAgents();
        }

        // Update dashboard if current agent
        if (currentAgent === data.agent_name) {
          updateDashboard(data.data);
        }
      });

      // Update dashboard with new data
      function updateDashboard(data) {
        // Update time data with formatted timestamp
        const now = new Date();
        const timeStr = now.toLocaleTimeString();
        timeData.push(timeStr);
        if (timeData.length > maxDataPoints) timeData.shift();

        // Update agent names
        document
          .querySelectorAll(
            "#cpu-agent-name, #ram-agent-name, #disk-agent-name, #net-agent-name"
          )
          .forEach(
            (el) =>
              (el.textContent = data.agent_name ? `(${data.agent_name})` : "")
          );

        // CPU Updates
        const cpuPercent = data.cpu.percent.toFixed(1);
        document.getElementById(
          "cpu-percent"
        ).innerHTML = `${cpuPercent}<span class="metric-unit">%</span>`;
        document.getElementById("cpu-load").textContent = `${cpuPercent}%`;
        updateProgressBar(
          document.getElementById("cpu-progress"),
          data.cpu.percent
        );
        document.getElementById("cpu-freq").innerHTML = `${Math.round(
          data.cpu.freq
        )}<span class="metric-unit">MHz</span>`;
        document.getElementById(
          "cpu-cores"
        ).textContent = `${data.cpu.cores}/${data.cpu.logical_cores}`;
        document.getElementById("cpu-temp").textContent = data.cpu.temperature
          ? `${data.cpu.temperature}Â°C`
          : "N/A";

        // Update CPU chart
        cpuData.push(data.cpu.percent);
        if (cpuData.length > maxDataPoints) cpuData.shift();
        charts.cpu.data.labels = timeData;
        charts.cpu.data.datasets[0].data = cpuData;
        charts.cpu.update();

        // RAM Updates
        const ramPercent = data.ram.percent.toFixed(1);
        document.getElementById(
          "ram-percent"
        ).innerHTML = `${ramPercent}<span class="metric-unit">%</span>`;
        document.getElementById("ram-usage").textContent = `${ramPercent}%`;
        updateProgressBar(
          document.getElementById("ram-progress"),
          data.ram.percent
        );
        document.getElementById("ram-used").innerHTML = `${(
          data.ram.used /
          1024 ** 3
        ).toFixed(2)}<span class="metric-unit">GB</span>`;
        document.getElementById("ram-free").innerHTML = `${(
          data.ram.free /
          1024 ** 3
        ).toFixed(2)}<span class="metric-unit">GB</span>`;
        document.getElementById("ram-total").innerHTML = `${(
          data.ram.total /
          1024 ** 3
        ).toFixed(2)}<span class="metric-unit">GB</span>`;

        // Update RAM chart
        ramData.push(data.ram.percent);
        if (ramData.length > maxDataPoints) ramData.shift();
        charts.ram.data.labels = timeData;
        charts.ram.data.datasets[0].data = ramData;
        charts.ram.update();

        // Disk Updates
        const diskInfoContainer = document.getElementById("disk-info");
        diskInfoContainer.innerHTML = "";

        if (data.disks && data.disks.length > 0) {
          const validDisks = data.disks.filter((d) => d.total > 0);

          if (validDisks.length > 0) {
            validDisks.forEach((disk, index) => {
              const diskItem = document.createElement("div");
              diskItem.className = "disk-item";
              diskItem.style.animationDelay = `${index * 0.1}s`;
              diskItem.innerHTML = `
                        <div class="disk-header">
                            <div class="disk-name">
                                <svg viewBox="0 0 24 24">
                                    <path d="M4 4h16v16H4V4zm2 2v12h12V6H6zm2 2h8v8H8V8z"/>
                                </svg>
                                ${disk.mountpoint}
                            </div>
                            <div class="disk-percent">${disk.percent.toFixed(
                              1
                            )}%</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress" style="width: ${
                              disk.percent
                            }%"></div>
                        </div>
                        <div class="disk-details">
                            <div class="disk-detail">
                                <div class="disk-detail-label">Used</div>
                                <div class="disk-detail-value">${formatBytes(
                                  disk.used
                                )}</div>
                            </div>
                            <div class="disk-detail">
                                <div class="disk-detail-label">Free</div>
                                <div class="disk-detail-value">${formatBytes(
                                  disk.free
                                )}</div>
                            </div>
                            <div class="disk-detail">
                                <div class="disk-detail-label">Total</div>
                                <div class="disk-detail-value">${formatBytes(
                                  disk.total
                                )}</div>
                            </div>
                        </div>
                    `;
              diskInfoContainer.appendChild(diskItem);
            });

            // Update disk chart
            charts.disk.data.labels = validDisks.map((d) => d.mountpoint);
            charts.disk.data.datasets[0].data = validDisks.map(
              (d) => d.used / 1024 ** 3
            ); // GB
            charts.disk.data.datasets[1].data = validDisks.map(
              (d) => d.free / 1024 ** 3
            ); // GB
            charts.disk.update();
          } else {
            diskInfoContainer.innerHTML =
              '<div class="no-data">No disk data available</div>';
          }
        } else {
          diskInfoContainer.innerHTML =
            '<div class="no-data">No disk data available</div>';
        }

        // Network Updates
        const sentSpeed = data.network.sent_speed_mbps || 0;
        const recvSpeed = data.network.recv_speed_mbps || 0;

        document.getElementById("net-sent").innerHTML = `${(
          data.network.bytes_sent /
          1024 ** 2
        ).toFixed(2)}<span class="metric-unit">MB</span>`;
        document.getElementById("net-recv").innerHTML = `${(
          data.network.bytes_recv /
          1024 ** 2
        ).toFixed(2)}<span class="metric-unit">MB</span>`;
        document.getElementById("net-speed").innerHTML = `${(
          sentSpeed + recvSpeed
        ).toFixed(2)}<span class="metric-unit">Mbps</span>`;

        // Update network chart
        netSentSpeedData.push(sentSpeed);
        netRecvSpeedData.push(recvSpeed);
        if (netSentSpeedData.length > maxDataPoints) netSentSpeedData.shift();
        if (netRecvSpeedData.length > maxDataPoints) netRecvSpeedData.shift();

        charts.network.data.labels = timeData.slice(-maxDataPoints);
        charts.network.data.datasets[0].data = netSentSpeedData;
        charts.network.data.datasets[1].data = netRecvSpeedData;
        charts.network.update();
      }

      // Theme toggle functionality
      document.getElementById("themeToggle").addEventListener("click", () => {
        document.body.classList.toggle("dark-theme");
        const isDark = document.body.classList.contains("dark-theme");
        localStorage.setItem("theme", isDark ? "dark" : "light");

        // Reinitialize charts with new theme colors
        Object.values(charts).forEach((chart) => chart.destroy());
        charts = initCharts();

        // Update dashboard if data exists
        if (currentAgent && agentDataCache[currentAgent]) {
          updateDashboard(agentDataCache[currentAgent]);
        }
      });

      // Initialize theme
      if (
        localStorage.getItem("theme") === "dark" ||
        (window.matchMedia("(prefers-color-scheme: dark)").matches &&
          !localStorage.getItem("theme"))
      ) {
        document.body.classList.add("dark-theme");
      }

      // Debugging helper
      window.debugSocket = socket;
      console.log("Socket.IO instance available as window.debugSocket");
    </script>
  </body>
</html>
